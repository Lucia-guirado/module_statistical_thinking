---
title: "AirBnB Madrid - Optimización de Precios"
format:
  html:
    theme: morph
    code-fold: true
    code-tools: false
    code-summary: "Ver código"
    code-overflow: wrap
    toc: true
    toc-location: left
    toc-depth: 2
    embed-resources: true
    css: styles.css
    output-file: "index.html"
execute:
  echo: false
  warning: false
  message: false
  error: false
editor: 
  markdown: 
    wrap: sentence
---

::: {style="display:inline-block;"}
<link href="https://cdn-icons-png.flaticon.com/128/3916/3916763.png" rel="icon">

<h6>

Lucía Moreno Guirado

Masters in Data Analytics

Module 3: Statistical Thinking

</h6>

::: {style="text-align:center"}
 </a> <a href="https://github.com/Lucia-guirado" title="Visit my GitHub" target="_blank" class="btn btn-light" style="margin: 10px; padding: 7;"> <img src="https://cdn-icons-png.flaticon.com/512/25/25231.png" alt="GitHub" class="icon-link" width="25" height="25"/> </a> <a href="https://www.linkedin.com/in/luc%C3%ADa-moreno-guirado-402233290/" title="Visit my LinkedIn" target="_blank"class="btn btn-light" style="margin: 10px; padding: 7;"> <img src="https://cdn-icons-png.flaticon.com/512/61/61109.png" alt="LinkedIn" class="icon-link" width="25" height="25"/> </a>
:::
:::


```{=html}
<script>
  // ============= SCROLL TO TOP =============
  window.onscroll = () => {
    document.getElementById("scrollToTopContainer").style.display = 
      (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) ? "block" : "none";
  };

  function goToTop() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }


  // ============= GALLERY ZOOM =============
  let zoomInitialized = false;
  
  function setupImageGallery() {
    if (zoomInitialized) return; // Evitar múltiples inicializaciones
    
    // Usar delegación de eventos en el documento
    document.addEventListener('click', function(e) {
      // Buscar el contenedor de figura más cercano
      const figure = e.target.closest('.matplotlib-figure-custom');
      
      if (figure) {
        e.preventDefault();
        console.log('Figura clickeada:', figure); // Debug
        
        // Buscar la imagen, SVG o canvas dentro del contenedor
        let imgElement = figure.querySelector('img, svg, canvas');
        
        if (!imgElement) {
          // Si no encuentra, tomar una captura del contenedor
          imgElement = figure.querySelector('div > img, div > svg, div > canvas') || figure;
        }
        
        console.log('Elemento imagen encontrado:', imgElement); // Debug
        
        createZoomModal(imgElement);
      }
    });
    
    zoomInitialized = true;
    console.log('Sistema de zoom inicializado'); // Debug
  }
  
  function createZoomModal(element) {
    console.log('Creando modal para:', element); // Debug
    
    // Crear modal usando las clases CSS definidas
    const modal = document.createElement('div');
    modal.className = 'zoom-modal active';
    
    // Crear contenedor del contenido
    const content = document.createElement('div');
    content.className = 'zoom-content';
    
    // Botón de cerrar
    const closeBtn = document.createElement('button');
    closeBtn.className = 'zoom-close';
    closeBtn.innerHTML = '×';
    closeBtn.title = 'Cerrar (ESC)';
    
    // Clonar el elemento y asegurar que sea visible
    const clonedElement = element.cloneNode(true);
    
    // Limpiar estilos que puedan interferir
    clonedElement.style.cssText = '';
    clonedElement.style.maxWidth = 'none';
    clonedElement.style.maxHeight = 'none';
    clonedElement.style.width = 'auto';
    clonedElement.style.height = 'auto';
    clonedElement.style.display = 'block';
    clonedElement.style.margin = '0';
    clonedElement.style.padding = '0';
    clonedElement.style.border = 'none';
    clonedElement.style.background = 'transparent';
    clonedElement.style.position = 'static';
    
    // Si es SVG, asegurar dimensiones
    if (clonedElement.tagName === 'svg') {
      clonedElement.setAttribute('width', '100%');
      clonedElement.setAttribute('height', 'auto');
    }
    
    console.log('Elemento clonado:', clonedElement); // Debug
    
    // Ensamblar modal
    content.appendChild(closeBtn);
    content.appendChild(clonedElement);
    modal.appendChild(content);
    
    // Agregar al DOM
    document.body.appendChild(modal);
    
    // Forzar reflow para activar animación
    modal.offsetHeight;
    
    // Prevenir scroll
    document.body.style.overflow = 'hidden';
    
    console.log('Modal agregado al DOM'); // Debug
    
    // Función de cierre
    const closeModal = () => {
      console.log('Cerrando modal'); // Debug
      modal.remove();
      document.body.style.overflow = '';
      document.removeEventListener('keydown', handleEsc);
    };
    
    // Event listeners
    closeBtn.onclick = closeModal;
    modal.onclick = (e) => {
      if (e.target === modal) closeModal();
    };
    
    // ESC key
    const handleEsc = (e) => {
      if (e.key === 'Escape') closeModal();
    };
    document.addEventListener('keydown', handleEsc);
  }

  // Inicialización simple
  document.addEventListener('DOMContentLoaded', function() {
    setupImageGallery();
  });
  
  // Backup initialization
  setTimeout(() => {
    if (!zoomInitialized) {
      setupImageGallery();
    }
  }, 2000);
</script>
```
::: index
# Index

-   [1. Contexto del Problema](#contexto)
-   [2. Definición del Problema](#problema)
-   [3. Roadmap del Análisis](#roadmap)
-   [4. Carga y Exploración de Datos](#datos)
-   [5. Análisis de Hipótesis](#hipotesis)
-   [6. Recomendaciones](#recomendaciones)
-   [7. Conclusiones](#conclusiones)

:::

```{python}
#| label: setup
#| code-summary: "Configuración inicial y librerías"

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import warnings
from IPython.display import HTML, display
warnings.filterwarnings('ignore')
import plotly.io as pio
pio.renderers.default = "iframe_connected"


# ============= COLORES CENTRALIZADOS =============
# Colores controlados por variables CSS en styles.css
FIGURE_COLORS = {
    'primary': '#9CAF88',
    'secondary': '#A8B99C', 
    'accent': '#87A96B',
    'dark': '#6B7F5C',
    'light': '#E8F4E6',
    'complement': '#B8C9A4'
}
LIGHTER_BG = '#F8FBF6'

# ============= CONFIGURACIÓN DE ESTILO =============
plt.style.use('seaborn-v0_8')
colors = list(FIGURE_COLORS.values())
sns.set_palette(colors)

# Configuración matplotlib
plt.rcParams.update({
    'figure.figsize': (5, 3),
    'figure.dpi': 120,
    'font.size': 10,
    'axes.titlesize': 12,
    'axes.labelsize': 10,
    'xtick.labelsize': 9,
    'ytick.labelsize': 9,
    'legend.fontsize': 9,
    'axes.prop_cycle': plt.cycler(color=colors),
    'axes.facecolor': LIGHTER_BG,
    'figure.facecolor': 'white',
    'axes.edgecolor': FIGURE_COLORS['dark'],
    'axes.linewidth': 1.2,
    'grid.color': FIGURE_COLORS['secondary'],
    'grid.alpha': 0.3
})

# ============= FUNCIONES HELPER =============
import os
import base64
from io import BytesIO

# Crear carpeta para imágenes si no existe
os.makedirs('figures', exist_ok=True)

def plot_start():
    """Iniciar contenedor de gráfico"""
    plt.figure(figsize=(5, 3));
    
def plot_end(save_name=None):
    """Finalizar y mostrar gráfico guardando como imagen"""
    plt.tight_layout()
    
    if save_name is None:
        # Generar nombre único basado en timestamp
        import time
        save_name = f"fig_{int(time.time()*1000)}"
    
    # Guardar imagen
    filepath = f'figures/{save_name}.png'
    plt.savefig(filepath, dpi=150, bbox_inches='tight', 
                facecolor='white', edgecolor='none')
    plt.close()
    
    # Mostrar con etiqueta HTML
    display(HTML(f'''
    <div class="matplotlib-figure-custom">
        <img src="{filepath}" alt="Figure" style="max-width: 100%; height: auto;
        margin-top:10px;">
    </div>
    '''))

def get_colormap():
    """Colormap personalizado"""
    from matplotlib.colors import LinearSegmentedColormap
    return LinearSegmentedColormap.from_list("sage", 
        [FIGURE_COLORS['light'], FIGURE_COLORS['primary'], FIGURE_COLORS['dark']])

```
# Contexto del Problema {#contexto}

Uno de nuestros clientes opera en el mercado de inmuebles. Está especialmente interesado en Madrid, donde posee una cantidad importante de viviendas
publicadas en la plataforma AirBnB y nos pide que le asesoremos respondiendo a la siguiente pregunta:

<div style="text-align:center; color:'#6B7F5C' ; font-size:larger; font-weight:bold; border: 2px '#6B7F5C'; padding: 10px;">
    ¿Qué puedo hacer para optimizar el precio de mis viviendas?
</div>

# Definición del Problema {#problema}

Nuestro cliente busca mejorar el rendimiento económico de sus viviendas, identificando acciones que pueda aumentar el precio de sus alojamientos.
Nuestro objetivo es analizar los factores que influyen en la fijación de los precios de Airbnb, mediante datos de propiedades de Airbnb en Madrid, y proporcionar una serie de estrategias prácticas basadas en datos, que permitan al cliente aumentar el precio de sus viviendas.


# Roadmap del Proyecto {#roadmap}

```{=html}
<div style="display:flex; justify-content:center; margin: 40px 0;">
    <div style="display:flex; flex-direction:column; gap:0;">
        <!-- Preparar datos -->
        <div style="display:flex; align-items:flex-start; gap:1.5em; margin-bottom:2.5em;">
            <div style="display:flex; flex-direction:column; align-items:center; gap:1em;">
                <div style="width:1.8em; height:1.8em; border-radius:50%; background:#4F8A8B; color:white; display:flex; align-items:center; justify-content:center; font-size:1em; flex-shrink:0;">1</div>
                <div style="width:3px; height:80px; background:#4F8A8B;"></div>
            </div>
            <div style="padding-top:0.3em;">
                <div style="font-weight:bold; color:#4F8A8B; font-size:1.1em;">Preparar datos</div>
                <div style="font-size:0.9em; color:#666;">Limpieza y variables</div>
            </div>
        </div>
        
        <!-- Explorar -->
        <div style="display:flex; align-items:flex-start; gap:1.5em; margin-bottom:2.5em; margin-left:0;">
            <div style="display:flex; flex-direction:column; align-items:center; gap:1em;">
                <div style="width:1.8em; height:1.8em; border-radius:50%; background:#4F8A8B; color:white; display:flex; align-items:center; justify-content:center; font-size:1em; flex-shrink:0;">2</div>
                <div style="width:3px; height:80px; background:#4F8A8B;"></div>
            </div>
            <div style="padding-top:0.3em;">
                <div style="font-weight:bold; color:#4F8A8B; font-size:1.1em;">Explorar</div>
                <div style="font-size:0.9em; color:#666;">Análisis y visualizaciones</div>
            </div>
        </div>
        
        <!-- Hipótesis -->
        <div style="display:flex; align-items:flex-start; gap:1.5em; margin-bottom:2.5em; margin-left:0;">
            <div style="display:flex; flex-direction:column; align-items:center; gap:1em;">
                <div style="width:1.8em; height:1.8em; border-radius:50%; background:#4F8A8B; color:white; display:flex; align-items:center; justify-content:center; font-size:1em; flex-shrink:0;">3</div>
                <div style="width:3px; height:80px; background:#4F8A8B;"></div>
            </div>
            <div style="padding-top:0.3em;">
                <div style="font-weight:bold; color:#4F8A8B; font-size:1.1em;">Hipótesis</div>
                <div style="font-size:0.9em; color:#666;">Planteamiento de hipótesis y análisis</div>
            </div>
        </div>
        <!-- Acciones -->
        <div style="display:flex; align-items:flex-start; gap:1.5em; margin-bottom:2.5em; margin-left:0;">
            <div style="display:flex; flex-direction:column; align-items:center; gap:1em;">
                <div style="width:1.8em; height:1.8em; border-radius:50%; background:#4F8A8B; color:white; display:flex; align-items:center; justify-content:center; font-size:1em; flex-shrink:0;">4</div>
                <div style="width:3px; height:80px; background:#4F8A8B;"></div>
            </div>
            <div style="padding-top:0.3em;">
                <div style="font-weight:bold; color:#4F8A8B; font-size:1.1em;">Acciones</div>
                <div style="font-size:0.9em; color:#666;">Recomendaciones para aumentar el valor de la vivienda</div>
            </div>
        </div>

    </div>
</div>
```
# Carga y Exploración de Datos {#datos}

### Carga de Datasets

Para realizar el análisis, se han utilizado cinco datasets proporcionados por la plataforma AirBnB que contienen información relevante sobre los alojamientos en Madrid. Estos datasets incluyen detalles sobre los anfitriones, las propiedades, la ubicación, las condiciones de reserva y las reseñas de los huéspedes.

```{python}
# Cargar los diferentes datasets
data_path = 'data/'

# Cargar cada archivo parquet
df_host = pd.read_parquet(data_path + 'airbnb_madrid_host.parquet')
df_property = pd.read_parquet(data_path + 'airbnb_madrid_property.parquet')
df_location = pd.read_parquet(data_path + 'airbnb_madrid_location.parquet')
df_conditions = pd.read_parquet(data_path + 'airbnb_madrid_conditions.parquet')
df_reviews = pd.read_parquet(data_path + 'airbnb_madrid_reviews.parquet')

print("Datasets cargados exitosamente:")
print(f"Host: {df_host.shape}")
print(f"Property: {df_property.shape}")
print(f"Location: {df_location.shape}")
print(f"Conditions: {df_conditions.shape}")
print(f"Reviews: {df_reviews.shape}")
```

### Descripción de Tablas

Los datos se componen de cinco tablas principales, cada una con un enfoque específico:

- **Host:** Información sobre los anfitriones, incluyendo su antigüedad y verificación.

- **Localización:** Datos geográficos de las propiedades, como barrio y coordenadas.

- **Propiedad:** Detalles de las características de las viviendas, como tipo, número de habitaciones y amenidades.

- **Condiciones:** Información sobre las condiciones de reserva, incluyendo precio, políticas de cancelación y mínimo de noches.

- **Reseñas:** Historial de reseñas y puntuaciones otorgadas por los huéspedes.

```{python}
# Descripción de las variables principales
import pandas as pd
from IPython.display import HTML, display

datasets_info = pd.DataFrame({
    'Dataset': ["Host","Localización", "Propiedad", "Condiciones", "Reseñas"],
    'Descripción': [
        "Información del anfitrión (senority, verificado)",
        "Ubicación geográfica (barrio, coordenadas, distancias)",
        "Características de la propiedad (tipo, habitaciones, amenidades)",
        "Condiciones de reserva (precio, políticas de cancelación, mínimo de noches)",
        "Historial de reseñas (puntuaciones, cantidad, actividad)"
    ],
    'Variables_Clave': [
        "host_response_time",
        "neighbourhood",
        "property_type, amenities, bedrooms",
        "price, minimum_nights, cancellation_policy", 
        "number_of_reviews, review_scores_cleanliness "
    ]
})

# Mostrar como tabla HTML renderizada
html_table = datasets_info.to_html(index=False, table_id="datasets_table", 
                                  classes="table table-striped table-hover",
                                  escape=False, border=0)
display(HTML(html_table))
```

### Fusión de Datasets

Para llevar a cabo un análisis integral, se han fusionado los cinco datasets en un único DataFrame basado en la columna común 'id', que identifica de manera única cada propiedad.
 
```{python}
# Fusionar todos los datasets por 'id'
df = df_host.merge(df_property, on='id', how='inner') \
    .merge(df_location, on='id', how='inner') \
    .merge(df_conditions, on='id', how='inner') \
    .merge(df_reviews, on='id', how='inner')

print(f"Dataset fusionado: {df.shape}")
# print(f"Propiedades únicas: {df['id'].nunique()}")

# # Información básica del dataset
# print("\nInformación general:")
# print(df.info())
```

### Transformación y filtrado de los datos

Se ha realizado un filtrado de los datos para centrarse únicamente en las viviendas que presentan características comparables a las de la cartera del cliente.

```{python}
df = df.query("property_type == 'apartment' and bedrooms <= 3 and bedrooms >=1 and bathrooms <= 2 and minimum_nights <= 7" )
df.shape

# Convertir variables categóricas
if 'bedrooms' in df.columns:
    df['bedrooms'] = df['bedrooms'].astype('category')
if 'minimum_nights' in df.columns:
    df['minimum_nights'] = df['minimum_nights'].astype('category')
if 'cancellation_policy' in df.columns:
    df['cancellation_policy'] = df['cancellation_policy'].astype('category') 
```

En la siguiente figura se observa el número de viviendas distribuidas en función del precio. Un número pequeño de viviendas tienen precios muy elevados, lo que puede distorsionar el análisis posterior. Por ello, se procede a eliminar los outliers de la variable objetivo (precio) utilizando el método del rango intercuartílico (IQR).

```{python}
plot_start()
sns.histplot(
    data= df,
    x='price'
)
plot_end()

# Calcular cuartiles
Q1 = df['price'].quantile(0.25)
Q3 = df['price'].quantile(0.75)
IQR = Q3 - Q1

# Definir límites de valores válidos
lower_bound = Q1 - 1.5 * IQR
upper_bound = Q3 + 1.5 * IQR

# Filtrar DataFrame eliminando outliers
df = df[(df['price'] >= lower_bound) & (df['price'] <= upper_bound)]

# Verificar
print(df.shape)
```

Antes del filtrado el número de viviendas que teníamos era de 21.020 viviendas, de las cuales 14.308 se ajustan a las características del cliente. Para poder ajustar mejor el análisis, se han eliminado los outliers de la variable objetivo (precio) quedándonos finalmente con 13.014 viviendas.


```{python}
plot_start()
sns.histplot(
    data= df,
    x='price'
)
plot_end()
```

Aquí se puede observar la distribución del precio tras eliminar los outliers, quedando un rango de precios entre 10€ y 200€ aproximadamente, donde se concentra la mayoría de las viviendas y se llevarán a cabo los análisis posteriores.


### Estadísticas Descriptivas

Los precios de las propiedades muestran una clara variedad. El precio promedio es de 67,58 €, mientras que la mediana es de 60 €, lo que indica que la mayoría de los alojamientos se concentran alrededor de ese valor. El rango va desde un mínimo muy bajo de 1 € hasta un máximo de 190 €, mostrando que hay tanto opciones muy económicas como otras mucho más caras. La desviación estándar de 37,60 € confirma que los precios están bastante dispersos y no siguen un valor típico muy marcado.

Al observar los percentiles, se ve que el 25% de las propiedades cuesta 38 € o menos, y el 75% no supera los 90 €, de modo que la mayor parte del mercado se mantiene en un nivel asequible. Solo un pequeño grupo, el 5% superior, supera los 147 €. En conjunto, la distribución muestra un mercado con una base amplia de precios bajos y medios, y una minoría de alojamientos más costosos que elevan el extremo superior de la distribución.

```{python}
# Estadísticas básicas de la variable objetivo: precio
print("ESTADÍSTICAS DEL PRECIO:")
print(f"Precio promedio: €{df['price'].mean():.2f}")
print(f"Precio mediano: €{df['price'].median():.2f}")
print(f"Precio mínimo: €{df['price'].min():.2f}")
print(f"Precio máximo: €{df['price'].max():.2f}")
print(f"Desviación estándar: €{df['price'].std():.2f}")

# Distribución de precios por cuartiles
quartiles = df['price'].quantile([0.25, 0.5, 0.75, 0.95])
print(f"\nDistribución de precios:")
for q, price in quartiles.items():
    print(f"  {q*100:.0f}% de propiedades: ≤ €{price:.2f}")
```


## Análisis Exploratorio {#exploratorio}
**Variables Clave del Estudio**

Para estructurar el análisis, se agrupan las variables en cuatro bloques principales:

**Localización**

- Barrio

- Distrito

**Características de la Propiedad**

- Tipo de propiedad

- Número de habitaciones

- Amenidades (WiFi, TV, aire acondicionado, etc.)

**Condiciones y Normativas**

- Política de cancelación
- Mínimo de noches

**Historial y Reseñas**

- Número de reseñas de limpieza


### Análisis por Ubicación

La gráfica muestra que la oferta de viviendas está muy concentrada en unos pocos barrios, especialmente en Centro y Embajadores, que destacan con mucha diferencia respecto al resto. Centro supera ampliamente las 3.000 propiedades, mientras que Embajadores se sitúa ligeramente por debajo. En contraste, barrios como Malasaña, La Latina, Arganzuela o Chamberí tienen una cantidad de alojamientos mucho más reducida, generalmente entre 400 y 600 propiedades. Esta concentración indica que la mayor parte del mercado turístico se ubica en zonas altamente demandadas por visitantes, mientras que el resto de barrios tienen una presencia menos masiva en la plataforma.

```{python}
# Análisis por barrios - Top 12 barrios por número de propiedades
top_neighborhoods = df['neighbourhood'].value_counts().head(12)
neighborhood_prices = df.groupby('neighbourhood')['price'].mean().sort_values(ascending=False).head(12)

# Número de propiedades por barrio
plot_start()
bars1 = plt.bar(range(len(top_neighborhoods)), top_neighborhoods.values, 
                color=FIGURE_COLORS['primary'], alpha=0.8, 
                edgecolor=FIGURE_COLORS['dark'], linewidth=1)
plt.xlabel('Barrios')
plt.ylabel('Número de Propiedades')
plt.title('Top 12 Barrios por Número de Propiedades', fontweight='bold', 
          color=FIGURE_COLORS['dark'])
plt.xticks(range(len(top_neighborhoods)), top_neighborhoods.index, rotation=45, ha='right')
plt.grid(True, alpha=0.3, color=FIGURE_COLORS['secondary'])
plot_end()
```

Al comparar esta oferta con los barrios más caros, se observa que el precio no está directamente relacionado con el volumen de propiedades. Zonas como Recoletos, Hispanoamérica, El Viso o Castellana —que no aparecen entre los barrios con mayor número de viviendas— presentan los precios promedio más altos, todos por encima de los 90 €. Estos barrios tienen menos propiedades disponibles, pero pertenecen a zonas residenciales de alto nivel, lo que explica sus precios elevados. Por el contrario, Centro, a pesar de ser el barrio con más oferta, no está entre los más caros, lo que indica que la elevada competencia probablemente modera los precios.

```{python}
# Estadísticas de los barrios más caros
print("BARRIOS MÁS CAROS (Precio Promedio):")
for i, (neighborhood, price) in enumerate(neighborhood_prices.head(10).items(), 1):
    count = df[df['neighbourhood'] == neighborhood].shape[0]
    print(f"   {i:2d}. {neighborhood}: €{price:.2f} ({count} propiedades)")
```

### Visualización agregado por Barrio

En el siguiente mapa se visualiza las viviendas agregados por barrio, donde se puede obtener un análisis geoespacial de los precios medios y la cantidad de propiedades disponibles en cada barrio de Madrid.

```{python}
# Análisis por barrio
barrio_stats = df.groupby('neighbourhood').agg({
    'price': ['mean', 'median', 'count'],
    'latitude': 'first',
    'longitude': 'first'
}).reset_index()

barrio_stats.columns = ['neighbourhood', 'precio_medio', 'precio_mediano', 'cantidad', 'latitude', 'longitude']
# Mapa de barrios
fig_barrios = px.scatter_mapbox(
    barrio_stats,
    lat='latitude',
    lon='longitude',
    size='cantidad',
    color='precio_medio',
    hover_name='neighbourhood',
    hover_data={
        'precio_medio': ':.0f',
        'cantidad': True,
        'latitude': ':.4f',
        'longitude': ':.4f'
    },
    color_continuous_scale='RdYlGn_r',
    size_max=50,
    zoom=11,
    center=dict(lat=40.4168, lon=-3.7038),
    title='Análisis por Barrio',
    # labels={'precio_medio': 'Precio Medio (€)'}
)

fig_barrios.update_layout(
    mapbox_style='open-street-map',
    margin={"r":0,"t":40,"l":0,"b":0},
    hovermode='closest'
)

fig_barrios
```

**Características del Mapa de Barrios**

Color de la burbuja:

**Rojo:** Barrios con los precios de propiedades más altos.

**Verde:** Barrios con los precios de propiedades más bajos.

**Tamaño de la burbuja:** Representa la cantidad de propiedades disponibles en cada barrio.

### Matriz de Correlaciones

La siguiente matriz de correlación muestra las relaciones entre las variables numéricas más relevantes del dataset. Se han seleccionado las 8 variables que presentan una mayor correlación absoluta con el precio, para entender mejor qué factores podrían influir en la fijación de los precios de las viviendas.
```{python}
# Seleccionar variables numéricas
numeric_columns = df.select_dtypes(include=[np.number]).columns
correlation_matrix = df[numeric_columns].corr()

# Obtener correlaciones con el precio
price_correlations = correlation_matrix['price'].abs().sort_values(ascending=False)

# Seleccionar top 8 variables más correlacionadas
top_corr_vars = price_correlations.head(8).index
correlation_subset = df[top_corr_vars].corr()

plt.figure(figsize=(10, 8))

sns.heatmap(
    correlation_subset,
    annot=True,
    cmap=get_colormap(),
    center=0,
    square=True,
    fmt='.2f',
    cbar_kws={"shrink": .7},
    linewidths=0.5,
    linecolor='white'
)

plt.xticks(rotation=45, ha='right')
plt.yticks(rotation=0)
plt.title(
    'Matriz de Correlación',
    fontweight='bold',
    color=FIGURE_COLORS['dark'],
    fontsize=16
)

plt.tight_layout()
plot_end()

```

Las variables más correlacionadas con el precio son el número de camas (beds) y la capacidad de alojamiento (accommodates), lo que indica que a medida que aumenta la capacidad de la vivienda, también tiende a aumentar su precio. Además, la presencia de aire acondicionado (air_conditioning) también muestra una correlación positiva con el precio, sugiriendo que las propiedades que ofrecen esta amenidad suelen tener precios más altos. Estos hallazgos resaltan la importancia de las características físicas y comodidades de las viviendas en la determinación de sus precios en el mercado de Airbnb.

### Análisis de Reseñas y Calificaciones

La siguiente figura muestra que el precio promedio de las viviendas se mantiene notablemente estable a través de todos los rangos de número de reseñas, con variaciones mínimas entre categorías que oscilan alrededor de los 67–69 euros. Esta uniformidad sugiere, de manera bastante clara, que la cantidad de reviews no ejerce una influencia significativa sobre el precio, lo que transmite la idea de un mercado donde el valor del producto permanece relativamente constante independientemente de su nivel de popularidad o exposición.



```{python}
# Análisis de reseñas
review_columns = ['number_of_reviews', 'review_scores_cleanliness']

if review_columns:
    for i, col in enumerate(review_columns[:2]):
        if col in df.columns and df[col].notna().sum() > 10:  # Solo si hay suficientes datos
            plot_start()
            
            # Crear bins para la variable de reseña
            if col == 'number_of_reviews':
                df[f'{col}_bin'] = pd.cut(df[col], bins=[0, 5, 20, 50, 100, float('inf')], 
                                        labels=['0-5', '6-20', '21-50', '51-100', '100+'])
            else:
                df[f'{col}_bin'] = pd.cut(df[col], bins=5, precision=1)
            
            bin_prices = df.groupby(f'{col}_bin')['price'].mean()
            
            bars = plt.bar(range(len(bin_prices)), bin_prices.values, 
                          color=colors[i % len(colors)], 
                          alpha=0.8, edgecolor=FIGURE_COLORS['dark'], linewidth=1)
            plt.xticks(range(len(bin_prices)), bin_prices.index, rotation=45)
            plt.ylabel('Precio Promedio (€)')
            plt.title(f'Precio vs {col.replace("_", " ").title()}', 
                     fontweight='bold', color=FIGURE_COLORS['dark'])
            plt.grid(True, alpha=0.3, color=FIGURE_COLORS['secondary'])
            
            plot_end()
```

En cuanto a las reseñas de limpieza, se observa una ligera tendencia ascendente en el precio promedio a medida que aumentan las puntuaciones de limpieza. Las propiedades con puntuaciones más altas tienden a tener precios ligeramente superiores, alcanzando un máximo alrededor de los 70 euros para las puntuaciones más elevadas. Aunque la variación no es drástica, esta tendencia sugiere que una mejor percepción de la limpieza puede contribuir a justificar precios marginalmente más altos, reflejando la importancia que los huéspedes otorgan a este aspecto en su experiencia de alojamiento.

```{python}
# Estadísticas de reseñas
if 'number_of_reviews' in df.columns:
    print("ESTADÍSTICAS DE RESEÑAS:")
    print(f"   Promedio de reseñas: {df['number_of_reviews'].mean():.1f}")
    print(f"   Mediana de reseñas: {df['number_of_reviews'].median():.1f}")
    
    # Propiedades sin reseñas
    no_reviews = (df['number_of_reviews'] == 0).sum()
    print(f"   Propiedades sin reseñas: {no_reviews} ({no_reviews/len(df)*100:.1f}%)")
```

### Hipótesis a Validar

***1. La presencia de amenities clave como aire acondicionado, televisión, calefacción, cocina o conexión a internet aumenta el precio de las viviendas.***

***2. El número de habitaciones impacta en el precio de las viviendas.***

***3. Reducir el número mínimo de noches de estancia sube el precio de las viviendas.***

***4. Con una política de cancelación más flexible el precio de la vivienda aumenta.***

***5. Si aumento el servicio de limpieza las reseñas de limpieza potencialmente subirán por ende el precio aumentará.***

---

# Análisis de Hipótesis {#hipotesis}

```{python}
# Función para crear boxplots con p-values estadísticos
def px_box_with_pvalue(df, cat_var, num_var, title=None, color_palette=None):
    import plotly.express as px
    import statsmodels.stats.weightstats as ws
    import statsmodels.api as sm
    from statsmodels.formula.api import ols

    data = df[[cat_var, num_var]].dropna()
    grupos = data.groupby(cat_var)[num_var]

    if len(grupos) == 2:
        g1, g2 = [g for _, g in grupos]
        t_stat, p_value, _ = ws.ttest_ind(g1, g2, usevar="unequal")
        test_name = "t-test"
    else:
        modelo = ols(f"{num_var} ~ C({cat_var})", data=data).fit()
        anova = sm.stats.anova_lm(modelo, typ=2)
        p_value = anova["PR(>F)"][0]
        test_name = "ANOVA"

    fig = px.box(
        data, 
        x=cat_var, 
        y=num_var, 
        color=cat_var,
        color_discrete_sequence=color_palette,
        title=title or f"{num_var} por {cat_var}",
        points="outliers"
    )
    """
    fig.add_annotation(
        x=0.5, y=data[num_var].max() * 0.95,
        text=f"{test_name} p-value = {p_value:.4f}",
        showarrow=False, font=dict(size=12, color="darkred"),
        bgcolor="rgba(255,255,255,0.8)", bordercolor="darkred", borderwidth=1
    )
    """
    # Fondo blanco y cuadrículas suaves
    fig.update_layout(
        plot_bgcolor="white",
        paper_bgcolor="white"
    )
    fig.update_xaxes(showgrid=True, gridcolor="lightgray")
    fig.update_yaxes(showgrid=True, gridcolor="lightgray")
    
    return fig
```


## Hipótesis 1: Amenities y Precio

**Planteamiento:** La presencia de amenities clave como aire acondicionado, televisión, calefacción, cocina o conexión a internet aumenta el precio de las viviendas.

En las siguientes figuras se muestran boxplots que representan la distribución de precios de las viviendas en función de la presencia o ausencia de ciertas amenities clave. Cada caja representa la distribución de precios para viviendas que cuentan con la amenidad (Sí) y aquellas que no la tienen (No). A su vez, se indica el p-valor del test estadístico (t-test o ANOVA) para evaluar si las diferencias en precios entre los dos grupos son estadísticamente significativas.
```{python}
# Crear boxplots para cada amenity
fig_wifi = px_box_with_pvalue(df, 'amenities_wifi_internet', 'price', 
                             'Precio por WiFi/Internet', color_palette=px.colors.qualitative.Pastel)
fig_wifi
```

Las viviendas con Wifi no muestran un diferencia significativa en terminos de precio medio en comparación con aquellas que lo tienen, ambas tienen un precio medio de 60€ la noche, por lo que la instalación del wifi no es clave para la optimización del precio de la vivienda.

```{python}
fig_tv = px_box_with_pvalue(df, 'amenities_tv', 'price', 'Precio por TV', color_palette=px.colors.qualitative.Pastel)
fig_tv
```

En este caso la diferencia de precio medio entre viviendas con TV (69€ la noche) y sin TV (35€ la noche) es sigifificativa, por lo que la instalación de una TV en la vivienda puede ser una buena estrategia para optimizar el precio medio del alojamiento.

```{python}
fig_ac = px_box_with_pvalue(df, 'amenities_air_conditioning', 'price', 'Precio por Aire Acondicionado', color_palette=px.colors.qualitative.Pastel)
fig_ac
```

Al igual que con la TV, las viviendas que disponen de aire acondicionado tienen un precio medio significativamente mayor (71€ la noche) en comparación con aquellas que no lo tienen (40€ la noche). Por lo tanto, la instalación de aire acondicionado puede ser una estrategia efectiva para aumentar el precio medio del alojamiento.

```{python}
fig_heating = px_box_with_pvalue(df, 'amenities_heating', 'price', 'Precio por Calefacción', color_palette=px.colors.qualitative.Pastel)
fig_heating
```

Con este amenitie ocurre lo mismo que anteriormente, las viviendas que disponen de calefacción tienen un precio medio significativamente mayor (64€ la noche) en comparación con aquellas que no lo tienen (40€ la noche). Por lo tanto, la instalación de calefacción puede ser una estrategia efectiva para aumentar el precio medio del alojamiento.

```{python}
fig_kitchen = px_box_with_pvalue(df, 'amenities_kitchen', 'price', 'Precio por Cocina', color_palette=px.colors.qualitative.Pastel)
fig_kitchen
```

La cocicna es otro de los amenities que impacta positivamente en el precio medio del alojamiento. Aquellas viviendas que disponen de cocina tienen un precio medio significativamente mayor (65€ la noche) en comparación con aquellas que no lo tienen (35€ la noche). Por lo tanto, la instalación de una cocina puede ser una estrategia efectiva para aumentar el precio medio del alojamiento.

### Conclusión de Hipótesis 1

**Hallazgos clave:**

- **Instalación de amenities:** TV, aire acondicionado, calefacción y cocina aumentan significativamente el precio medio.

Analizando los datos de amenities se puede oservar que aquellas como que la vivienda incluya TV, aire acondicionado, calefaccion o cocina tienen un precio medio mayor que aquellas viviendas que no las incluyen. Sin embargo, la instalación de Wifi no es estadisticamente significativa en el precio, por lo que la isntalación de wifi no deberia de ser prioritaria a la hora de aumentar el precio de un alojamiento.

---

## Hipótesis 2: Número de Habitaciones y Precio

**Planteamiento:** El número de habitaciones impacta en el precio de las viviendas.

En la siguiente figura se ve reflejado el número de habtaciones (entre 1 y 3 habitaciones) y su relación con el precio medio del alojamiento. Cada caja representa la distribución de precios para cada número de habitaciones que contenga la vivienda, incluyendo mediana, cuartiles y posibles outliers. A su vez, se indica el p-valor del test estadístico (ANOVA) para evaluar si las diferencias en precios entre los distintos grupos son estadísticamente significativas. 

```{python}
fig_bedrooms = px_box_with_pvalue(df, 'bedrooms', 'price', 'Precio por Número de Habitaciones', color_palette=px.colors.qualitative.Pastel)
fig_bedrooms
```

En figura se observa que la mediana de los precios aumenta significativamente al pasar de 1 a 2 habitaciones (de 60€ a 75€ la noche). Sin embargo, al aumentar de 2 a 3 habitaciones, el incremento en la mediana del precio es mucho menor (de 75€ a 80€ la noche). Por lo tanto, se puede deducir que el nñumero óptimoi de habitaciones, en este rango, es de 2, de manera que se maxima el precio medio ndel alojamiento.

### Conclusión de Hipótesis 2

**Hallazgos clave:**

- **Incremento 1→2 habitaciones:** Aumento de precio significativo.

- **Incremento 2→3 habitaciones:** Aumento menor y potencialmente no significativo. 

Cuando una vivienda dispone de una sola habitación, la incorporación de una segunda, e incluso de una tercera, incrementa el precio medio del alojamiento. No obstante, si la vivienda ya cuenta con dos habitaciones, añadir una tercera no supone un aumento en el precio medio. Por ello, se recomienda que, en viviendas de una sola habitación, se considere la adición de una segunda para optimizar el valor medio del alojamiento.

---

## Hipótesis 3: Noches Mínimas y Precio

**Planteamiento:** Reducir el número mínimo de noches de estancia sube el precio de las viviendas.

En la siguiente figura se ve reflejado el número mínimo de noches (entre 1 y 7 noches) y su relación con el precio medio del alojamiento. Cada caja representa la distribución de precios para cada número mínimo de noches, incluyendo mediana, cuartiles y posibles outliers. A su vez, se indica el p-valor del test estadístico (ANOVA) para evaluar si las diferencias en precios entre los distintos grupos son estadísticamente significativas. 

```{python}
fig_min_nights = px_box_with_pvalue(df, 'minimum_nights', 'price', 'Precio por Noches Mínimas', color_palette=px.colors.qualitative.Pastel)
fig_min_nights
```

Como se puerde observar en la figura, la mediana los precios entre 1 y 2 dos noches (51€ y 65€ la noche) es relativamente baja en comparación con la mediana de las propiedades que requieren un mínimo de 3 o 4 noches (80€ y 90€ la noche). Conforme van aumentando las noches mínimas (entre 5 y 7 noches) el precio medio de las propiedades tiende a disminuir ligeramente (75€ y 70€ la noche). Esto podría deberse a que las propiedades que requieren un mayor número de noches mínimas suelen ser más económicas para atraer reservas más largas, por lo que eservas de muchas noches no necesariamente generan precios más altos

### Conclusión de Hipótesis 3

**Hallazgos clave:**

- Propiedades con 3-4 noches mínimas tienen precios superiores al resto del número de noches mínimas.

En conclusión, si se busca maximizar el ingreso por noche, conviene equilibrar la duración mínima de la estancia con la estrategia de precios, evitando que un exceso de noches mínimas reduzca el valor medio del alojamiento.

---

## Hipótesis 4: Política de Cancelación

**Planteamiento:** Con una política de cancelación más flexible el precio de la vivienda aumenta.

En la siguiente figura se ve reflejado los distintos tipos de políticas de cancelación y su relación con el precio medio del alojamiento. Cada caja representa la distribución de precios para cada tipo de política de cancelación, incluyendo mediana, cuartiles y posibles outliers. A su vez, se indica el p-valor del test estadístico (ANOVA) para evaluar si las diferencias en precios entre los distintos grupos son estadísticamente significativas.

```{python}
fig_cancellation = px_box_with_pvalue(df, 'cancellation_policy', 'price', 'Precio por Política de Cancelación', color_palette=px.colors.qualitative.Pastel)
fig_cancellation
```

Se observa en la figura que aquellas viviendas que disponen de una política de cancelación super estricta de 30 días tienen un precio medio significativamente más alto (120€ la noche) en comparación con las políticas de cancelación más flexibles, como la política flexible (65€ la noche) o moderada (75€ la noche). Sin embargo, aquellas que tienen un apolítica super estricta de 60 días, su precio medio es el más bajo de todos (52€ la noche). Esto sugiere que los anfitriones que ofrecen políticas de cancelación más estrictas pueden justificar precios más altos, posiblemente debido a la percepción de mayor compromiso por parte de los huéspedes, pero que una política excesivamente estricta puede disuadir a potenciales huéspedes, resultando en precios más bajos.

### Conclusión de Hipótesis 4

**Hallazgos clave:**

- **Política estricta:** Propiedades con cancelación superestricta tienen precios altos.

- **Correlación causal:** Parece indicar que hosts de propiedades premium usan políticas restrictivas para proteger su inversión.

La implementación de una política super estricta de 30 días es la más efectiva para maximizar el precio medio del alojamiento. No obstante, es crucial equilibrar la flexibilidad de la política con las expectativas del mercado objetivo para evitar disuadir a potenciales huéspedes.

---

## Hipótesis 5: Reseñas de Limpieza

**Planteamiento:** Si aumento el servicio de limpieza las reseñas de limpieza potencialmente subirán por ende el precio aumentará.

La siguente figura muestra un boxplot que representa la distribución de precios de las viviendas en función de las calificaciones de limpieza recibidas en las reseñas. Cada caja representa la distribución de precios para cada nivel de calificación de limpieza, incluyendo mediana, cuartiles y posibles outliers.

```{python}
fig= px.box(
    df, 
    x='review_scores_cleanliness', 
    y='price',
    color='review_scores_cleanliness',
    color_discrete_sequence=px.colors.qualitative.Pastel,
    title='Precio por Calificación de Limpieza'
)

fig.update_layout(
        plot_bgcolor="white",
        paper_bgcolor="white"
    )
fig.update_xaxes(showgrid=True, gridcolor="lightgray")
fig.update_yaxes(showgrid=True, gridcolor="lightgray")
```

En la figura se observa que las propiedades con calificaciones de limpieza más altas (9-10) tienden a tener precios medios más altos (alrededor de 85-90€ la noche) en comparación con aquellas con calificaciones más bajas (6-7), que tienen precios medios significativamente más bajos (alrededor de 50-60€ la noche). Sin embargo, las viviendas que tienen calificaciones de 2 tienen un precio medio de 58€ la noche, similar a las de 9 o 10, por lo que hace falta un análisis más profundo para entender este comportamiento atípico.

```{python}
fig= px.histogram(
    df, 
    x='review_scores_cleanliness',
    color='review_scores_cleanliness',
    color_discrete_sequence=px.colors.qualitative.Pastel,
    title='Número de viviendas por calificación de limpieza'
)

fig.update_layout(
        plot_bgcolor="white",
        paper_bgcolor="white"
    )
fig.update_xaxes(showgrid=True, gridcolor="lightgray")
fig.update_yaxes(showgrid=True, gridcolor="lightgray")
```

En la figura se observa el número de viviendas en función de la calificación de limpieza. Un total de 6285 tienen una calificación de limpieza de 10, siendo la mayoría de las viviendas. A medida que la calificación disminuye, el número de viviendas también disminuye, con solo 31 viviendas que tienen una calificación de limpieza de 2. Por lo tanto, la mediana de precio de las viviendas con calificación de limpieza de 2 puede estar sesgada debido al bajo número de viviendas en esa categoría. De esta manera, se puede concluir que una mejor calificación de limpieza está asociada con precios más altos.

### Conclusión de Hipótesis 5

**Hallazgos clave:**

- **Precio vs Limpieza:** Mejores calificaciones de limpieza correlacionan con precios más altos.

Esto sugiere que una mejor percepción de la limpieza por parte de los huéspedes puede justificar precios más altos, posiblemente debido a la mayor satisfacción del cliente y la disposición a pagar más por una experiencia de alojamiento percibida como más limpia y cómoda.

---

# Recomendaciones {#recomendaciones}

## Estrategias de Optimización de Precios

```{python}
# Crear tabla de recomendaciones basada en el análisis
recommendations_data = {
    'Estrategia': [
        'Adición de Amenities',
        'Adición de Habitaciones',
        'Ajuste de Noches Mínimas',
        'Políticas de Cancelación',
        'Gestión de la limpieza'
    ],
    'Acción_Específica': [
        'Añadir TV, aire acondicionado, calefacción, o cocina en propiedades básicas',
        'Propiedas con 1 habitación: añadir habitaciones adicionales',
        'Ajustar mínimo de noches a 3-4 para maximizar precio medio',
        'Implementar política estricta en las propiedades',
        'Aumentar la calidad del servicio de limpieza para mejorar reseñas'
    ],
    'Inversión_Requerida': [
        'Media - Tiempo y mejoras servicio',
        'Alta - Instalaciones físicas',
        'Baja - Ajuste de noches',
        'Baja - Cambio de políticas',
        'Media - Mejora de procesos y seguimiento'
    ]
}

recommendations_df = pd.DataFrame(recommendations_data)
```

```{python}
# Mostrar tabla de recomendaciones
recomendaciones_df = pd.DataFrame({
    'Estrategia': [
        'Adición de Amenities',
        'Adición de Habitaciones',
        'Ajuste de Noches Mínimas',
        'Políticas de Cancelación',
        'Gestión de la limpieza'
    ],
    'Acción_Específica': [
        'Añadir WiFi, TV, aire acondicionado, calefacción, o cocina en propiedades básicas',
        'Propiedas con 1 habitación: añadir habitaciones adicionales',
        'Ajustar mínimo de noches a 3-4 para maximizar precio medio',
        'Implementar política estricta en las propiedades',
        'Aumentar la calidad del servicio de limpieza para mejorar reseñas'
    ],
    'Inversión_Requerida': [
        'Media - Tiempo y mejoras servicio',
        'Alta - Instalaciones físicas',
        'Baja - Ajuste de noches',
        'Baja - Cambio de políticas',
        'Media - Mejora de procesos y seguimiento'
    ]
})

# Mostrar como tabla HTML estilizada
html_table = recomendaciones_df.to_html(index=False, escape=False, 
                                       table_id="recomendaciones_table",
                                       classes="table table-striped table-hover",
                                       border=0)
display(HTML(html_table))
```

### Desarrollo de recomendaciones
::: {.panel-tabset}

### **Amenities** 
Priorizar la instalación de una TV, aire acondicionado, cocina completa y calefacción en propiedades nuevas. El WiFi es imprescindible pero no diferenciador.

Entre todas las amenities mencionadas que pueden ser una buena estrategia para aumentar el precio medio del alojamiento, se recomienda colocar una TV primero ya que puede ser la opción más económica y con mayor impacto en el precio medio. Posteriormente, se recomienda instalar aire acondicionado, cocina completa y calefacción, en función del presupuesto disponible. 

### **Habitaciones** 
Si una propiedad tiene 1 habitación, invertir en la división/reforma para crear 2 habitaciones es altamente rentable. Pasar de 2 a 3 habitaciones tiene menor rentabilidad.

En las viviendas que se dispongo de una sola habitación, es altamente recomendado invertir en la creación de una segunda habitación, ya que esto incrementa significativamente el precio medio del alojamiento. Sin embargo, si la vivienda ya cuenta con dos habitaciones, añadir una tercera no supone un aumento significativo en el precio medio, por lo que se debe evaluar cuidadosamente la rentabilidad de dicha inversión.

### **Noches Mínimas** 
Ajustar el mínimo de noches a 3-4 para maximizar precio medio, evitando valores extremos (1 noche o >5 noches).

Se debe ajustar el mínimo de noches para poder obtener un equilibrio entre la duración de la estancia y la estrategia de precios. Se recomienda establecer un mínimo de noches entre 3 y 4, ya que esto maximiza el precio medio del alojamiento. Evitar establecer un mínimo de 1 noche o más de 5 noches, ya que estos extremos pueden reducir el valor medio del alojamiento.

### **Cancelación**
Ajustar la política de cancelación según el tipo de propiedad.

La implementeación de una política de cancelación debe de ser considerada en función de la propiedad y sus características. Para propiedades premium o nuevas, se recomienda implementar una política estricta de cancelación, ya que esto permite justificar precios más altos. Por otro lado, para propiedades estándar o competitivas, se recomienda utilizar políticas de cancelación moderadas o flexibles, ya que mantiene un precio competitivo y maximiza la ocupación. Aun así, este indicador debe de ser estudiado en conjunto con otros factores para determinar la mejor estrategia de precios, ya que se puede deber a que viviendas premium utilizan políticas restrictivas para proteger su inversión.

### **Limpieza** 
Mejorar la calidad del servicio de limpieza para obtener mejores reseñas y justificar precios más altos.

Las viviendas que reciben mejores calificaciones de limpieza tienden a tener precios medios más altos. Por lo tanto, se recomienda invertir en mejorar la calidad del servicio de limpieza, ya sea mediante la contratación de personal adicional, la implementación de estándares más rigurosos o la utilización de productos de limpieza de alta calidad puede resultar en mejores reseñas por parte de los huéspedes, lo que a su vez justifica precios más altos y mejora la reputación del alojamiento.

:::

# Conclusión {#conclusiones}

En conclusión, las estrategias recomendadas se centran en mejorar las características y servicios ofrecidos por las propiedades para maximizar el precio medio del alojamiento. La implementación de estas recomendaciones debe ser evaluada cuidadosamente en función del presupuesto disponible, el tipo de propiedad y las expectativas del mercado objetivo para asegurar una optimización efectiva del valor del alojamiento.

```{=html}
<div id="scrollToTopContainer" style="position: fixed; bottom: 20px; right: 20px; display: none;">
  <button onclick="goToTop()" id="btnScrollToTop" type="button" class="btn">
    ↑
  </button>
</div>
```



